import numpy as np
from scipy.stats import multivariate_normal
from . import SignalSource


class PointSource(SignalSource):
    def __init__(
            self,
            RA,
            DEC,
            attitudeStateName='attitude'
    ):
        SignalSource.__init__(self)
        self.__RA__ = RA
        self.__DEC__ = DEC
        self.__RaDec__ = {'RA': RA, 'DEC': DEC}
        self.attitudeStateName = attitudeStateName

        return

    def RaDec(self):
        return(self.__RaDec__)

    def unitVec(
            self,
            RaDec):
        cosD = np.cos(self.__RaDec__['DEC'])
        sinD = np.sin(self.__RaDec__['DEC'])
        cosRA = np.cos(self.__RaDec__['RA'])
        sinRA = np.sin(self.__RaDec__['RA'])

        return np.array([cosD * cosRA, cosD * sinRA, sinD])
    
    def computeAssociationProbability(
            self,
            measurement,
            stateDict,
            validationThreshold=0
    ):

        if (
                ('RA' in measurement) and
                ('DEC' in measurement) and
                ('attitude' in stateDict)
        ):
            attitudeState = stateDict[self.attitudeStateName]['stateObject']

            measurementMatrices = attitudeState.getMeasurementMatrices(
                measurement,
                source=self
            )
            P = attitudeState.covariance()

            H = measurementMatrices['H']['unitVector']

            R = measurementMatrices['R']['unitVector']

            dY = measurementMatrices['dY']['unitVector']
            
            residualVariance = H.dot(P).dot(H.transpose()) + R
            try:
                uniformProbability = 1/(4 * np.pi)
                maxProb = 1/np.sqrt(np.linalg.det(2 * np.pi * residualVariance))
                if maxProb < uniformProbability:
                    print("using uniform probability")
                    probability = uniformProbability
                else:
                    probability = multivariate_normal.pdf(dY, cov=residualVariance)

            except:
                print('P:')
                print(P)
                print('H:')
                print(H)
                print('R:')
                print(R)
                print('S:')                
                print(residualVariance)
                print('dY:')
                print(dY)
                raise ValueError(
                    'Error computing probability.'
                    )
            # print('')
        else:
            probability=0

        return(probability)
